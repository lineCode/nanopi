// For 74HC595

#include "common.h"
#include "libfahw-gpio.h"
#include "libfahw-74hc.h"

static int SCLK = -1;
static int RCLK = -1; 
static int DIO = -1;

unsigned char MatrixLedCharMap[38][9]={
        {'0', 0x38,0x44,0x4c,0x54,0x64,0x44,0x38,0x00},//0
        {'1', 0x10,0x18,0x14,0x10,0x10,0x10,0x10,0x10},//1
        {'2', 0x7E,0x2,0x2,0x7E,0x40,0x40,0x40,0x7E},//2
        {'3', 0x3E,0x2,0x2,0x3E,0x2,0x2,0x3E,0x0},//3
        {'4', 0x8,0x18,0x28,0x48,0xFE,0x8,0x8,0x8},//4
        {'5', 0x3C,0x20,0x20,0x3C,0x4,0x4,0x3C,0x0},//5
        {'6', 0x3C,0x20,0x20,0x3C,0x24,0x24,0x3C,0x0},//6
        {'7', 0x3E,0x22,0x4,0x8,0x8,0x8,0x8,0x8},//7
        {'8', 0x0,0x3E,0x22,0x22,0x3E,0x22,0x22,0x3E},//8
        {'9', 0x3E,0x22,0x22,0x3E,0x2,0x2,0x2,0x3E},//9
        {'A', 0x8,0x14,0x22,0x3E,0x22,0x22,0x22,0x22},//A
        {'B', 0x3C,0x22,0x22,0x3E,0x22,0x22,0x3C,0x0},//B
        {'C', 0x3C,0x40,0x40,0x40,0x40,0x40,0x3C,0x0},//C
        {'D', 0x7C,0x42,0x42,0x42,0x42,0x42,0x7C,0x0},//D
        {'E', 0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x7C},//E
        {'F', 0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x40},//F
        {'G', 0x3C,0x40,0x40,0x40,0x40,0x44,0x44,0x3C},//G
        {'H', 0x44,0x44,0x44,0x7C,0x44,0x44,0x44,0x44},//H
        {'I', 0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x7C},//I
        {'J', 0x3C,0x8,0x8,0x8,0x8,0x8,0x48,0x30},//J
        {'K', 0x0,0x24,0x28,0x30,0x20,0x30,0x28,0x24},//K
        {'L', 0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x7C},//L
        {'M', 0x81,0xC3,0xA5,0x99,0x81,0x81,0x81,0x81},//M
        {'N', 0x0,0x42,0x62,0x52,0x4A,0x46,0x42,0x0},//N
        {'O', 0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},//O
        {'P', 0x3C,0x22,0x22,0x22,0x3C,0x20,0x20,0x20},//P
        {'Q', 0x1C,0x22,0x22,0x22,0x22,0x26,0x22,0x1D},//Q
        {'R', 0x3C,0x22,0x22,0x22,0x3C,0x24,0x22,0x21},//R
        {'S', 0x0,0x1E,0x20,0x20,0x3E,0x2,0x2,0x3C},//S
        {'T', 0x0,0x3E,0x8,0x8,0x8,0x8,0x8,0x8},//T
        {'U', 0x42,0x42,0x42,0x42,0x42,0x42,0x22,0x1C},//U
        {'V', 0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18},//V
        {'W', 0x0,0x49,0x49,0x49,0x49,0x2A,0x1C,0x0},//W
        {'X', 0x0,0x41,0x22,0x14,0x8,0x14,0x22,0x41},//X
        {'Y', 0x41,0x22,0x14,0x8,0x8,0x8,0x8,0x8},//Y
        {'Z', 0x0,0x7F,0x2,0x4,0x8,0x10,0x20,0x7F},//Z
        {'0', 0x8,0x7F,0x49,0x49,0x7F,0x8,0x8,0x8}, //?
        {'0', 0xFE,0xBA,0x92,0xBA,0x92,0x9A,0xBA,0xFE},//?
};

unsigned int MatrixLedRowMap[9]={
  // 1        2        3      4       5        6       7       8
    0x0080, 0x0004, 0x0100, 0x0010, 0x8000, 0x0200, 0x4000, 0x0800
};

unsigned int MatrixLedColumnMap[9]={
  // 1        2        3      4       5        6       7       8
    0x0008, 0x2000, 0x1000, 0x0040, 0x0400, 0x0020, 0x0002, 0x0001
};

#define ROW_MASK  (0x346B)

static void LEDOutput(unsigned int c)           
{   
    unsigned char i;
    for (i=16; i>=1; i--)
    {
        if (c&0x8000) {
            setGPIOValue(DIO, GPIO_HIGH);
        } else { 
            setGPIOValue(DIO, GPIO_LOW);
        }
        c<<=1;
        setGPIOValue(SCLK, GPIO_LOW);
        setGPIOValue(SCLK, GPIO_HIGH);
    }
}

static int MatrixLedDispRow(unsigned int row, unsigned char byte) 
{
    unsigned char i;
    unsigned int x=0xffff;

    clearLastError();
    if (row < 1 || row > 8) {
        setLastError("Unsupported row");
        return -1;
    } 

    for (i=0; i<8; i++)
    {
        if ( !!(byte&(0x80>>i)) )
        {
            x &= ~(MatrixLedColumnMap[i]); 
        }
    }
    x &= ROW_MASK;
    x |= MatrixLedRowMap[row-1];
    LEDOutput(x);

    setGPIOValue(RCLK, GPIO_LOW);
    setGPIOValue(RCLK, GPIO_HIGH);
    return 0;
}

EXPORT void MatrixLedDeInit(void)                       
{
    unexportGPIOPin(SCLK);
    unexportGPIOPin(RCLK);
    unexportGPIOPin(DIO);
    SCLK = RCLK = DIO = -1;
}

EXPORT int MatrixLedDispChar(unsigned char c)                    
{
    unsigned char i,j;
    clearLastError();

    for (i=0; i<38; i++)
    {
        if (MatrixLedCharMap[i][0] == c) {
            break;
        }
    }
    if(i < 0 || i> 37) {
        setLastError("Unsupported charac to MatrixLed");
        return -1;
    }

    for (j=1; j<=8; j++)
    {
        MatrixLedDispRow(j, MatrixLedCharMap[i][j]); 

    }
    return 0;
}

EXPORT void MatrixLedCleanScreen()
 {
    LEDOutput(ROW_MASK);
    setGPIOValue(RCLK, GPIO_LOW);
    setGPIOValue(RCLK, GPIO_HIGH);
 }


EXPORT int MatrixLedInit(int sclkPin, int rclkPin, int dioPin)               
{
    SCLK = sclkPin;         // CK
    RCLK = rclkPin;         // LD
    DIO = dioPin;           // DI
    
    int ret = 0;
    if (exportGPIOPin(SCLK) == -1) {  
        return -1;
    }

    if (setGPIODirection(SCLK, GPIO_OUT) == -1) {
        ret = -1;
    }
    if (exportGPIOPin(RCLK) == -1) {
        unexportGPIOPin(SCLK);
        return -1;
    }

    if (setGPIODirection(RCLK, GPIO_OUT) == -1) {
        ret = -1;
    }

    if (exportGPIOPin(DIO) == -1) {
        unexportGPIOPin(SCLK);
        unexportGPIOPin(RCLK);
        return -1;
    }

    if (setGPIODirection(DIO, GPIO_OUT) == -1) {
        ret = -1;
    }

    return ret;
}   
